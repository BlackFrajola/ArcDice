<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ArcDice â€“ Roll the Dice!</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Ethers v5 UMD -->
  <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js"></script>
  <style>
    body {
      background: #000;
      color: #0f0;
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 40px 10px;
    }
    h1 {
      font-size: 36px;
      margin-bottom: 10px;
    }
    .dice {
      font-size: 40px;
      margin-right: 10px;
      vertical-align: middle;
    }
    p {
      font-size: 18px;
    }
    button {
      padding: 18px 32px;
      font-size: 20px;
      margin: 10px;
      background: #00ff00;
      color: #000;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      background: #00cc00;
    }
    button:disabled {
      background: #555;
      color: #999;
      cursor: not-allowed;
    }
    input[type="number"] {
      padding: 14px;
      font-size: 24px;
      width: 90px;
      text-align: center;
      border-radius: 6px;
      border: 1px solid #0f0;
      background: #fff;
      color: #000;
    }
    #status {
      margin-top: 25px;
      font-size: 18px;
      min-height: 24px;
    }
    .status-error {
      color: #ff3333;
    }
    .status-ok {
      color: #00ff00;
    }
    .status-warn {
      color: #ffcc00;
    }
    .address {
      font-size: 14px;
      margin-top: 8px;
      color: #aaa;
    }
  </style>
</head>
<body>
  <h1><span class="dice">ðŸŽ²</span>ArcDice â€“ Roll the Dice!</h1>
  <p>Bet 1 USDC, pick a number from 1â€“6. Win 5.7x if you hit! (Arc Testnet)</p>

  <div>
    <button id="connect-btn" onclick="connectWallet()">Connect wallet</button>
  </div>
  <div class="address" id="address-label"></div>

  <div style="margin-top: 40px;">
    <p>Your bet (1â€“6):</p>
    <input type="number" id="choice" min="1" max="6" value="3" />
    <button id="roll-btn" onclick="rollDice()">ðŸŽ² ROLL DICE!</button>
  </div>

  <div id="status">Connect your wallet to start.</div>

  <script>
    // >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
    // EDIT THESE THREE CONSTANTS WITH YOUR REAL VALUES
    // >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
    const ARC_CHAIN_ID = 5042002; // Arc Testnet chainId (decimal)
    const CONTRACT = "0xYOUR_ARCDICE_CONTRACT_HERE"; // <-- ArcDice contract address
    const USDC = "0xYOUR_USDC_ADDRESS_HERE";         // <-- USDC on Arc Testnet
    // <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

    // Minimal ABI for ArcDice + USDC
    const GAME_ABI = [
      {
        "inputs": [{ "internalType": "uint256", "name": "choice", "type": "uint256" }],
        "name": "roll",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "totalRolls",
        "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "totalWins",
        "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
        "stateMutability": "view",
        "type": "function"
      }
    ];

    const USDC_ABI = [
      {
        "inputs": [
          { "internalType": "address", "name": "owner", "type": "address" },
          { "internalType": "address", "name": "spender", "type": "address" }
        ],
        "name": "allowance",
        "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "address", "name": "spender", "type": "address" },
          { "internalType": "uint256", "name": "amount", "type": "uint256" }
        ],
        "name": "approve",
        "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }],
        "stateMutability": "nonpayable",
        "type": "function"
      }
    ];

    let provider = null;
    let signer = null;
    let game = null;
    let usdc = null;
    let currentAccount = null;

    const statusEl = document.getElementById("status");
    const connectBtn = document.getElementById("connect-btn");
    const rollBtn = document.getElementById("roll-btn");
    const addrLabel = document.getElementById("address-label");

    function setStatus(message, type = "ok") {
      statusEl.textContent = message;
      statusEl.className = "";
      if (type === "error") statusEl.classList.add("status-error");
      if (type === "warn") statusEl.classList.add("status-warn");
      if (type === "ok") statusEl.classList.add("status-ok");
    }

    function shortAddress(addr) {
      if (!addr) return "";
      return addr.slice(0, 6) + "..." + addr.slice(-4);
    }

    async function connectWallet() {
      try {
        if (!window.ethereum) {
          alert("No wallet detected. Please install Rabby or MetaMask.");
          setStatus("No wallet detected in this browser.", "error");
          return;
        }

        connectBtn.disabled = true;
        setStatus("Connecting walletâ€¦", "warn");

        // "any" prevents EIP-155 chain changes from breaking provider
        provider = new ethers.providers.Web3Provider(window.ethereum, "any");

        const accounts = await provider.send("eth_requestAccounts", []);
        currentAccount = accounts[0];
        signer = provider.getSigner();

        const network = await provider.getNetwork();
        console.log("Connected network:", network);

        addrLabel.textContent = `Connected: ${shortAddress(currentAccount)} (chainId ${network.chainId})`;
        connectBtn.textContent = "Wallet connected";

        // Warn if user is not on Arc Testnet, but don't explode
        if (network.chainId !== ARC_CHAIN_ID) {
          setStatus(
            `Wallet connected on chainId ${network.chainId}. Please switch to Arc Testnet and reconnect.`,
            "warn"
          );
          connectBtn.disabled = false;
          return;
        }

        // Instantiate contracts
        game = new ethers.Contract(CONTRACT, GAME_ABI, signer);
        usdc = new ethers.Contract(USDC, USDC_ABI, signer);

        // Check and set allowance (approve 500 USDC)
        setStatus("Checking USDC allowanceâ€¦", "warn");
        const required = ethers.utils.parseUnits("500", 6); // 500 USDC
        const allowance = await usdc.allowance(currentAccount, CONTRACT);

        if (allowance.lt(required)) {
          setStatus("Approving USDC for ArcDiceâ€¦", "warn");
          const tx = await usdc.approve(CONTRACT, required);
          await tx.wait();
        }

        setStatus("Ready. Choose a number and roll!", "ok");
        connectBtn.disabled = false;
      } catch (err) {
        console.error("connectWallet error:", err);
        setStatus("Failed to connect. Open DevTools console for details.", "error");
        connectBtn.disabled = false;
      }
    }

    async function rollDice() {
      try {
        if (!game || !signer || !currentAccount) {
          setStatus("Connect your wallet first.", "error");
          return;
        }

        let choice = document.getElementById("choice").value;
        choice = parseInt(choice, 10);

        if (isNaN(choice) || choice < 1 || choice > 6) {
          setStatus("Choose a number between 1 and 6.", "error");
          return;
        }

        rollBtn.disabled = true;
        setStatus(`Sending transactionâ€¦ Rolling with choice ${choice}.`, "warn");

        const tx = await game.roll(choice);
        console.log("roll tx:", tx.hash);
        setStatus("Waiting for confirmationâ€¦", "warn");
        await tx.wait();

        setStatus("ðŸŽ‰ Dice rolled! Check your wallet / explorer for result.", "ok");
        rollBtn.disabled = false;
      } catch (err) {
        console.error("rollDice error:", err);
        setStatus("Roll failed. Check Arc Testnet, faucet balance and allowance.", "error");
        rollBtn.disabled = false;
      }
    }
  </script>
</body>
</html>
